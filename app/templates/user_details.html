{% extends "index.html" %}
{% load static %}

{% block title %}User Details{% endblock %}

{% block content %}
<style>
    td,
    th {
        text-align: center;
    }
</style>
<link href="https://cdn.datatables.net/v/dt/dt-2.3.2/datatables.min.css" rel="stylesheet"
    integrity="sha384-d76uxpdVr9QyCSR9vVSYdOAZeRzNUN8A4JVqUHBVXyGxZ+oOfrZVHC/1Y58mhyNg" crossorigin="anonymous">
<div class="row">
    <div class="col-sm-9">
        <div class="card mt-5 mx-auto" style="width: 95% !important;">
            <div class="card-header-right p-5 pb-0">
                <div class="d-flex justify-content-between">
                    <h5 class="card-title">USER DETAILS</h5>
                    <button type="button" class="btn btn-primary float-right" style="float: right;" data-toggle="modal"
                        data-target="#save-user-modal" onclick="showModal()">
                        Add User
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-border" id="user-list">
                        <thead>
                            <tr>
                                <th>S.NO</th>
                                <th>NAME</th>
                                <th>EMAIL</th>
                                <th>ROLE</th>
                                <th>STATUS</th>
                                <th>EDIT</th>
                                <th>DELETE</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for data in users %}
                            <tr>
                                <td>{{forloop.counter}}</td>
                                <td>{{data.user__username}}</td>
                                <td>{{data.user__email}}</td>
                                <td>{{data.role__role}}</td>
                                <td class="no-sort">
                                    <input type="checkbox" {% if data.user__is_active %} checked {% endif %}
                                        data-toggle="toggle" onclick="toggle_status('{{data.user_id}}', this)">

                                </td>
                                <td class="no-sort"
                                    onclick="updatedetails('{{data.id}}','{{data.user__username}}','{{data.user__email}}','{{data.role_id}}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                        class="bi bi-wrench-adjustable-circle-fill" viewBox="0 0 16 16">
                                        <path
                                            d="M6.705 8.139a.25.25 0 0 0-.288-.376l-1.5.5.159.474.808-.27-.595.894a.25.25 0 0 0 .287.376l.808-.27-.595.894a.25.25 0 0 0 .287.376l1.5-.5-.159-.474-.808.27.596-.894a.25.25 0 0 0-.288-.376l-.808.27z" />
                                        <path
                                            d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m-6.202-4.751 1.988-1.657a4.5 4.5 0 0 1 7.537-4.623L7.497 6.5l1 2.5 1.333 3.11c-.56.251-1.18.39-1.833.39a4.5 4.5 0 0 1-1.592-.29L4.747 14.2a7.03 7.03 0 0 1-2.949-2.951M12.496 8a4.5 4.5 0 0 1-1.703 3.526L9.497 8.5l2.959-1.11q.04.3.04.61" />
                                    </svg>
                                </td>
                                <td class="no-sort"
                                    onclick="deletedetails('{{data.id}}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                        class="bi bi-wrench-adjustable-circle-fill" viewBox="0 0 16 16">
                                        <path
                                            d="M6.705 8.139a.25.25 0 0 0-.288-.376l-1.5.5.159.474.808-.27-.595.894a.25.25 0 0 0 .287.376l.808-.27-.595.894a.25.25 0 0 0 .287.376l1.5-.5-.159-.474-.808.27.596-.894a.25.25 0 0 0-.288-.376l-.808.27z" />
                                        <path
                                            d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m-6.202-4.751 1.988-1.657a4.5 4.5 0 0 1 7.537-4.623L7.497 6.5l1 2.5 1.333 3.11c-.56.251-1.18.39-1.833.39a4.5 4.5 0 0 1-1.592-.29L4.747 14.2a7.03 7.03 0 0 1-2.949-2.951M12.496 8a4.5 4.5 0 0 1-1.703 3.526L9.497 8.5l2.959-1.11q.04.3.04.61" />
                                    </svg>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-3">
        <div class="card mt-5 mx-auto" style="width: 95% !important;">
            <div class="card-header-right p-5 pb-0">
                <div class="d-flex justify-content-between">
                    <h5 class="card-title">ROLES</h5>
                    <button type="button" class="btn btn-primary float-right" style="float: right;" data-toggle="modal"
                        data-target="#save-user-modal" onclick="showRoleModal()">
                        ROLES
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-border" id="user-list">
                        <thead>
                            <tr>
                                <th>S.NO</th>
                                <th>ROLE</th>
                                <th>EDIT</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for data in roles %}
                            <tr>
                                <td>{{forloop.counter}}</td>
                                <td>{{data.role}}</td>

                                <td class="no-sort" onclick="updateRoles('{{data.id}}','{{data.role}}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                        class="bi bi-wrench-adjustable-circle-fill" viewBox="0 0 16 16">
                                        <path
                                            d="M6.705 8.139a.25.25 0 0 0-.288-.376l-1.5.5.159.474.808-.27-.595.894a.25.25 0 0 0 .287.376l.808-.27-.595.894a.25.25 0 0 0 .287.376l1.5-.5-.159-.474-.808.27.596-.894a.25.25 0 0 0-.288-.376l-.808.27z" />
                                        <path
                                            d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m-6.202-4.751 1.988-1.657a4.5 4.5 0 0 1 7.537-4.623L7.497 6.5l1 2.5 1.333 3.11c-.56.251-1.18.39-1.833.39a4.5 4.5 0 0 1-1.592-.29L4.747 14.2a7.03 7.03 0 0 1-2.949-2.951M12.496 8a4.5 4.5 0 0 1-1.703 3.526L9.497 8.5l2.959-1.11q.04.3.04.61" />
                                    </svg>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Modal -->
<div class="modal fade" id="save-user-modal" tabindex="-1" role="dialog" aria-labelledby="save-user-modalTitle"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <form id="save-user">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">ADD USER</h5>
                    <!-- <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true" onclick="hideModal()">&times;</span>
                    </button> -->
                </div>
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="text" name="id" id="id" hidden>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email address</label>
                        <input type="email" name="email" class="form-control" id="email" placeholder="name@example.com"
                            required>
                    </div>
                    <div class="mb-3">
                        <label for="name" class="form-label">Name</label>
                        <input type="name" name="name" class="form-control" id="name"
                            onkeypress="return /[a-z ]/i.test(event.key)" placeholder="Enter Name" required>
                    </div>
                    <div class="mb-3">
                        <label for="role" class="form-label">Role</label>
                        <select class="form-select" id="role" name="role" aria-label="Default select example" required>
                            <option selected>Select Role</option>
                            {% for data in roles %}
                            <option value="{{data.id}}">{{data.role}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="alert alert-danger" id="user-alert" role="alert" style="display: none;">
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal"
                        onclick="hideModal()">Close</button>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="save-role-modal" tabindex="-1" role="dialog" aria-labelledby="save-user-modalTitle"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <form id="save-role">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">ADD ROLE</h5>
                    <!-- <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true" onclick="hideModal()">&times;</span>
                    </button> -->
                </div>
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="text" name="id" id="role-id" hidden>
                    <div class="mb-3">
                        <label for="name" class="form-label">Name</label>
                        <input type="name" name="role" class="form-control" id="role-name" placeholder="Enter Role"
                            required onkeypress="return /[a-z- ]/i.test(event.key)">
                    </div>
                    <div class="alert alert-danger" id="role-alert" role="alert" style="display: none;">
                    
                </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal"
                            onclick="hideRoleModal()">Close</button>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                    </div>
            </form>
        </div>
    </div>
</div>
<script src="{% static 'js/jquery.js' %}"></script>
<script src="{% static 'js/jquery.min.js' %}"></script>

<script src="https://cdn.datatables.net/v/dt/dt-2.3.2/datatables.min.js"
    integrity="sha384-JRUjeYWWUGO171YFugrU0ksSC6CaWnl4XzwP6mNjnnDh4hfFGRyYbEXwryGwLsEp"
    crossorigin="anonymous"></script>
<script>
    console.log($(".card"))
    $(document).ready(function () {
        $('#user-list').DataTable({
            "lengthMenu": [[10, 20, 50, -1], [10, 20, 50, "All"]],
            columnDefs: [
                { orderable: false, targets: -1 },
                { orderable: false, targets: -2 },
                { orderable: false, targets: -3 },

                { searchable: false, targets: -1 },
                { searchable: false, targets: -2 },
                { searchable: false, targets: -3 },
            ]
        });
    });
    function showModal() {
        $('#save-user')[0].reset();
        user_tag = document.getElementById('user-alert').style.display = 'none';
        $('#save-user-modal').modal('show')
    }
    function hideModal() {
        $('#save-user-modal').modal('hide')
    }
    function showRoleModal() {
        $('#save-role')[0].reset();
        role_tag = document.getElementById('role-alert').style.display = 'none';
        $('#save-role-modal').modal('show')
    }
    function hideRoleModal() {
        $('#save-role-modal').modal('hide')
    }
</script>
<script>
    $('#save-user').submit(function (event) {
        event.preventDefault();
        console.log("Form submitted!");
        var formData = $(this).serialize();
        console.log("Form data:", formData);
        $.ajax({
            url: '/user/',
            data: formData,
            method: "POST",
            success: function (response) {
                console.log(response)
                if (response.data != 'Success') {
                    user_tag = document.getElementById('user-alert')
                    user_tag.innerText = response.data;
                    user_tag.style.display = 'block'
                    return false
                }
                hideModal()
                location.reload();
            }
        });
    })
    $('#save-role').submit(function (event) {
        event.preventDefault();
        console.log("Form submitted!");
        var formData = $(this).serialize();
        console.log("Form data:", formData);
        $.ajax({
            url: '/role/',
            data: formData,
            method: "POST",
            success: function (response) {
                console.log(response)
                if (response.data != 'Success') {
                    role_tag = document.getElementById('role-alert')
                    role_tag.innerText = response.data;
                    role_tag.style.display = 'block'
                    return false
                }
                hideModal()
                location.reload();
            }
        });
    })
</script>
<script>
    function updatedetails(id, name, email, role) {
        $("#id").val(id);
        $("#name").val(name);
        $("#email").val(email);
        $("#role").val(role);
        $('#save-user-modal').modal('show')
    }
    function updateRoles(id, role) {
        $("#role-id").val(id);
        $("#role-name").val(role);
        $('#save-role-modal').modal('show')
    }
</script>
<script>
    function toggle_status(id, status) {
        console.log(id, status.checked)
        status = status.checked ? "True" : "False";
        $.ajax({
            url: '/toggle_status/',
            method: "POST",
            data: {
                'id': id,
                'status': status,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function (response) {
                console.log(response)
                
            }
        });
    }
</script>
<script>
    function deletedetails(id){
        $.ajax({
            url: '/delete_user/',
            method: "POST",
            data: {
                'id': id,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function (response) {
                console.log(response)
                location.reload()
            }
        });
    }
</script>
{% endblock %}